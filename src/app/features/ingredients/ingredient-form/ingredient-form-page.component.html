<div class="ingredient-form-page">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <div class="header-content">
          <mat-icon>{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
          {{ isEditMode ? "Modifier l'ingrédient" : 'Nouvel ingrédient' }}
        </div>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content *ngIf="!isLoading; else loading">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <!-- Informations générales -->
        <section class="form-section">
          <h2>
            <mat-icon>info</mat-icon>
            Informations générales
          </h2>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nom de l'ingrédient *</mat-label>
            <input matInput formControlName="name" />
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
              <mat-error>Le nom est requis (min. 2 caractères)</mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Catégorie *</mat-label>
              <mat-select formControlName="category">
                @for (cat of categories; track cat) {
                  <mat-option [value]="cat">{{ cat }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Unité *</mat-label>
              <mat-select formControlName="unitId">
                @for (u of units; track u.id) {
                  <mat-option [value]="u.id">{{ u.symbol }} - {{ u.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </section>

        <!-- Image -->
        <section class="form-section">
          <h2>
            <mat-icon>image</mat-icon>
            Image
          </h2>

          <div class="image-upload">
            @if (imagePreview) {
              <div class="image-preview">
                <img [src]="imagePreview" alt="Prévisualisation" />
                <button
                  type="button"
                  mat-stroked-button
                  color="warn"
                  (click)="removeImage()"
                >
                  <mat-icon>delete</mat-icon>
                  Supprimer l'image
                </button>
              </div>
            } @else {
              <label class="upload-label">
                <input
                  type="file"
                  accept="image/*"
                  (change)="onImageSelected($event)"
                  hidden
                />
                <span class="upload-btn">
                  <mat-icon>photo_camera</mat-icon>
                  Ajouter une image
                </span>
              </label>
            }
          </div>
        </section>

        <!-- Informations nutritionnelles -->
        <section class="form-section">
          <h2>
            <mat-icon>nutrition</mat-icon>
            Informations nutritionnelles (pour 100g)
          </h2>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Calories (kcal)</mat-label>
              <input matInput type="number" formControlName="calories" step="0.1" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Protéines (g)</mat-label>
              <input matInput type="number" formControlName="protein" step="0.1" />
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Glucides (g)</mat-label>
              <input matInput type="number" formControlName="carbs" step="0.1" />
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Lipides (g)</mat-label>
              <input matInput type="number" formControlName="fats" step="0.1" />
            </mat-form-field>
          </div>
        </section>

        <!-- Actions -->
        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="onCancel()">
            Annuler
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!form.valid"
          >
            <mat-icon>{{ isEditMode ? 'edit' : 'add' }}</mat-icon>
            {{ isEditMode ? 'Modifier' : 'Créer' }} l'ingrédient
          </button>
        </div>
      </form>
    </mat-card-content>

    <ng-template #loading>
      <div class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    </ng-template>
  </mat-card>
</div>
