<h2 mat-dialog-title>
  {{ isEditMode ? 'Modifier la recette' : 'Nouvelle recette' }}
</h2>

<form [formGroup]="form" (ngSubmit)="onSubmit()" mat-dialog-content class="recipe-form">
  <!-- Section: Informations g√©n√©rales -->
  <div class="form-section">
    <h3>Informations g√©n√©rales</h3>

    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nom de la recette *</mat-label>
        <input matInput formControlName="name" />
        @if (form.get('name')?.invalid && form.get('name')?.touched) {
          <mat-error>Le nom est requis (min. 3 caract√®res)</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-group">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description *</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
        @if (form.get('description')?.invalid && form.get('description')?.touched) {
          <mat-error>La description est requise</mat-error>
        }
      </mat-form-field>
    </div>

    <div class="form-row">
      <div class="form-group">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Cat√©gorie *</mat-label>
          <mat-select formControlName="category">
            <mat-option value="">-- S√©lectionner --</mat-option>
            <mat-option value="Plats">Plats</mat-option>
            <mat-option value="Salades">Salades</mat-option>
            <mat-option value="Desserts">Desserts</mat-option>
            <mat-option value="Soupes">Soupes</mat-option>
            <mat-option value="Petit-d√©jeuner">Petit-d√©jeuner</mat-option>
            <mat-option value="Autre">Autre</mat-option>
          </mat-select>
          @if (form.get('category')?.invalid && form.get('category')?.touched) {
            <mat-error>La cat√©gorie est requise</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-group">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Portions *</mat-label>
          <input matInput type="number" formControlName="servings" min="1" />
          @if (form.get('servings')?.invalid && form.get('servings')?.touched) {
            <mat-error>Minimum 1 portion</mat-error>
          }
        </mat-form-field>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Temps de pr√©paration (min) *</mat-label>
          <input matInput type="number" formControlName="prepTime" min="0" />
          @if (form.get('prepTime')?.invalid && form.get('prepTime')?.touched) {
            <mat-error>Valeur invalide</mat-error>
          }
        </mat-form-field>
      </div>

      <div class="form-group">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Temps de cuisson (min) *</mat-label>
          <input matInput type="number" formControlName="cookTime" min="0" />
          @if (form.get('cookTime')?.invalid && form.get('cookTime')?.touched) {
            <mat-error>Valeur invalide</mat-error>
          }
        </mat-form-field>
      </div>
    </div>
  </div>

  <!-- Section: Image -->
  <div class="form-section">
    <h3>Image de la recette</h3>
    <div class="image-upload">
      @if (imagePreview()) {
        <div class="image-preview">
          <img [src]="imagePreview()" alt="Pr√©visualisation" />
          <button type="button" mat-stroked-button color="warn" (click)="removeImage()">
            Supprimer l'image
          </button>
        </div>
      } @else {
        <label class="upload-label">
          <input type="file" accept="image/*" (change)="onImageSelected($event)" hidden />
          <span class="upload-btn">üì∑ Ajouter une image</span>
        </label>
      }
    </div>
  </div>

  <!-- Section: Ingr√©dients -->
  <div class="form-section">
    <div class="section-header">
      <h3>Ingr√©dients *</h3>
      <span class="section-hint">{{ selectedIngredients().length }} ajout√©(s)</span>
    </div>

    <div class="add-ingredient-form">
      <div class="form-row">
        <div class="form-group flex-2">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Ingr√©dient</mat-label>
            <mat-select formControlName="ingredientId">
              <mat-option value="">-- S√©lectionner --</mat-option>
              @for (ingredient of availableIngredients(); track ingredient.id) {
                <mat-option [value]="ingredient.id">
                  {{ ingredient.name }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Quantit√©</mat-label>
            <input matInput type="number" formControlName="quantity" step="0.1" min="0.1" />
          </mat-form-field>
        </div>

        <div class="form-group">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Unit√©</mat-label>
            <mat-select formControlName="unit">
              <mat-option value="g">g</mat-option>
              <mat-option value="kg">kg</mat-option>
              <mat-option value="ml">ml</mat-option>
              <mat-option value="l">l</mat-option>
              <mat-option value="c">c. √† soupe</mat-option>
              <mat-option value="cc">c. √† caf√©</mat-option>
              <mat-option value="unit√©">unit√©</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <button
        type="button"
        mat-raised-button
        color="accent"
        (click)="addIngredient()"
        [disabled]="!isIngredientFieldsValid()"
        class="btn-add-ingredient"
      >
        + Ajouter l'ingr√©dient
      </button>
    </div>

    @if (selectedIngredients().length > 0) {
      <div class="ingredients-list">
        @for (ingredient of selectedIngredients(); track ingredient.ingredientId) {
          <div class="ingredient-item">
            <div class="ingredient-content">
              <span class="ingredient-name">{{ getIngredientName(ingredient.ingredientId) }}</span>
              <span class="ingredient-quantity"
                >{{ ingredient.quantity }} {{ ingredient.unit }}</span
              >
            </div>
            <button
              type="button"
              mat-icon-button
              color="warn"
              (click)="removeIngredient(ingredient.ingredientId)"
              matTooltip="Supprimer"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }
      </div>
    }

    @if (selectedIngredients().length === 0) {
      <div class="validation-hint error">
        <mat-icon>warning</mat-icon>
        <span>Au moins un ingr√©dient est requis</span>
      </div>
    }
  </div>

  <!-- Section: √âtapes -->
  <div class="form-section">
    <div class="section-header">
      <h3>√âtapes de la recette *</h3>
      <span class="section-hint">{{ steps().length }} ajout√©e(s)</span>
    </div>

    <div class="add-step-form">
      <div class="form-group">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nouvelle √©tape</mat-label>
          <textarea
            matInput
            [(ngModel)]="newStep"
            [ngModelOptions]="{ standalone: true }"
            rows="2"
            placeholder="D√©crivez l'√©tape..."
          ></textarea>
        </mat-form-field>
      </div>

      <button
        type="button"
        mat-raised-button
        color="accent"
        (click)="addStep()"
        [disabled]="!canAddStep()"
        class="btn-add-step"
      >
        + Ajouter une √©tape
      </button>
    </div>

    @if (steps().length > 0) {
      <ol class="steps-list">
        @for (step of steps(); track $index) {
          <li class="step-item">
            <div class="step-content">
              <span class="step-number">{{ $index + 1 }}</span>
              <span class="step-text">{{ step }}</span>
            </div>
            <button
              type="button"
              mat-icon-button
              color="warn"
              (click)="removeStep($index)"
              matTooltip="Supprimer"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </li>
        }
      </ol>
    }

    @if (steps().length === 0) {
      <div class="validation-hint error">
        <mat-icon>warning</mat-icon>
        <span>Au moins une √©tape est requise</span>
      </div>
    }
  </div>
</form>

<div mat-dialog-actions class="dialog-actions">
  <button mat-button (click)="closeForm()">Annuler</button>
  <button
    mat-raised-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="!isFormValid()"
    [title]="!isFormValid() ? 'Veuillez remplir tous les champs requis' : ''"
  >
    {{ isEditMode ? 'Modifier' : 'Cr√©er' }} la recette
  </button>
</div>
